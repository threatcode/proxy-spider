name: Proxy Scraper and Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Runs every 6 hours; adjust as needed.

jobs:
  proxy-scraper-checker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.7"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install

      - name: Configure Proxy Scraper
        run: |
          # Modify config.ini here if needed; for example:
          echo "[proxy]" > config.ini
          echo "url = http://example.com/check" >> config.ini
          echo "sort_by_speed = true" >> config.ini
          echo "geolocation = true" >> config.ini
          echo "anonymous_only = false" >> config.ini
          echo "output_folder = .out" >> config.ini

      - name: Run Proxy Scraper
        run: |
          poetry run python proxy_spider.py

      - name: Push .out Directory to Proxy List Repository
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone https://github.com/username/proxy-list.git proxy-list-repo
          cp -r .out/* proxy-list-repo/
          cd proxy-list-repo
          git add .
          git commit -m "Update proxy list from workflow"
          git push https://$PROXY_LIST_REPO_TOKEN@github.com/username/proxy-list.git main
        env:
          PROXY_LIST_REPO_TOKEN: ${{ secrets.PROXY_LIST_REPO_TOKEN }}
